name: auto-fix

on:
  workflow_run:
    workflows: ["tests"]
    types: ["completed"]

permissions:
  contents: write
  pull-requests: write

jobs:
  fix:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download test log
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.workflow_run.id }}
          name: pytest-output

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/fix-tests.md
          output-file: codex-output.md
          sandbox: workspace-write
          safety-strategy: drop-sudo
          model: ${{ secrets.OPENAI_MODEL || 'gpt-5.2-codex' }}

      - name: Upload Codex output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-output
          path: codex-output.md

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          title: "Fix failing tests"
          body: "Automated fix based on failing test output."
          branch: "codex/auto-fix"
          commit-message: "Fix failing tests"
