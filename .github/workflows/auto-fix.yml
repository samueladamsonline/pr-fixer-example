name: auto-fix

on:
  workflow_run:
    workflows: ["tests"]
    types: ["completed"]

permissions:
  contents: write
  pull-requests: write

jobs:
  fix:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download test log
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.workflow_run.id }}
          name: pytest-output

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/fix-tests.md
          output-file: codex-output.md
          sandbox: workspace-write
          safety-strategy: drop-sudo
          model: gpt-5.2-codex

      - name: Upload Codex output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex-output
          path: codex-output.md

      - name: Generate PR metadata
        id: pr_meta
        run: |
          set -euo pipefail

          mapfile -t files < <(git diff --name-only)
          file_count=${#files[@]}

          if [[ "$file_count" -eq 0 ]]; then
            title="Fix failing tests"
            commit="Fix failing tests"
            body="Automated fix based on failing test output."
          else
            if [[ "$file_count" -eq 1 ]]; then
              title="Fix tests in ${files[0]}"
            else
              title="Fix tests across ${file_count} files"
            fi
            commit="$title"

            codex_summary=""
            if [[ -s codex-output.md ]]; then
              codex_summary="$(cat codex-output.md)"
            fi

            body="Automated fix based on failing test output."
            if [[ -n "$codex_summary" ]]; then
              body="$(printf '%s\n\n%s\n%s\n' \
                "$body" \
                "Codex rationale:" \
                "$codex_summary")"
            fi
            body="$(printf '%s\n\n%s\n%s\n' \
              "$body" \
              "Files changed:" \
              "$(printf '%s\n' "${files[@]}")")"
          fi

          echo "title=$title" >> "$GITHUB_OUTPUT"
          echo "commit=$commit" >> "$GITHUB_OUTPUT"
          {
            delimiter="PR_BODY_EOF_$(date +%s%N)"
            echo "body<<$delimiter"
            echo "$body"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"

      - name: Remove Codex output file
        if: always()
        run: rm -f codex-output.md

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          title: ${{ steps.pr_meta.outputs.title }}
          body: ${{ steps.pr_meta.outputs.body }}
          branch: "codex/auto-fix"
          base: main
          commit-message: ${{ steps.pr_meta.outputs.commit }}
